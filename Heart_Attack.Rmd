---
title: "Heart_Attack"
author: "Josu Lecuona"
date: "2023-02-08"
output: html_document
---



## Primero de todo cargamos los datos y vemos de que clase son cada variable del dataset. Algunas de ellas los pasamos a factor, otras a numerico. Y hacemos algun cambio en la variable target, ya que se han cometido algunos errores en la creacion del dataset. 

```{r}
library(readr)
library(tidyverse)
setwd("C:\\Users\\MI\\Desktop\\MASTER\\MCH I")
data <- read.csv("heart_mod_2023-02-08.csv", sep = 'p')


sapply(data, class)

data$sex <- as.factor(data$sex)
levels(data$sex) <- c("Female", "Male")

data$cp <- as.factor(data$cp)
levels(data$cp) <- c("Asymthomatic", "Atypical angina", "No angina", "Typical Angina")


data$restecg <- as.factor(data$restecg)
levels(data$restecg) <- c("Hypertrophy", "Normal", "Abnormalities")

data$exang <- as.factor(data$exang)
levels(data$exang) <- c("No", "Yes")


data$fbs <- as.factor(data$fbs)
levels(data$fbs) <- c("No", "Yes")

data$slope <- as.factor(data$slope)
levels(data$slope) <- c("Descending", "Flat", "Ascending")

data$thal <- as.factor(data$thal)
levels(data$thal) <- c("Fixed Defect", "Normal Flow", "Reversable Defect")

data$target <- as.character(data$target)
data$target[which(data$target=="11")] <- "1"
data$target[which(data$target=="O")] <- "0"
data$target <- as.factor(data$target)
levels(data$target) <- c("Yes", "No")

as.numeric(data$oldpeak)
as.numeric(data$chol)




```

## Separating data, metemos en un dataset aquellas variables que son numericas (data_num) y en otro dataset aquellas variables que son de tipo factor (data_fac). 

```{r separating}
data[,1] <- NULL
type_class <- sapply(data,class)
table(type_class)

data$oldpeak <- gsub(",",".", data$oldpeak) ## Cambia en oldpeak los decimales de coma a punto

data_num <- data[,type_class %in% c("integer", "numeric")]
data_fac <- data[,type_class %in% c("factor")]

```

## Realizamos un summary de las variables numericas para ver que cosas salen fuera de lo normal, despues procedemos a cambiar aquellas anomalias vistas a primera vista. En la edad hay una persona que tiene 640 anos y eso es imposible por lo que es un error, tambien podemos ver que hay varios NA. Los NA de cada variable los cambiamos por la media de aquella variable


```{r}
as.integer(data$oldpeak)
summary(data_num)

tail(sort(data_num$age))
data_num$year[data_num$age == 640] <- 64
data_num$year[data_num$age == 630] <- 63
data_num$year[data_num$age == 350] <- 35



data_num$chol[data_num$chol == 5] <- NA
data_num$trestbps[data_num$trestbps == 1540] <- 154

mean_trestbps <- mean(data$trestbps, na.rm = TRUE)
data_num$trestbps[is.na(data_num$trestbps)] <- mean_trestbps

mean_chol <- mean(data$chol, na.rm = TRUE)
data_num$chol[is.na(data_num$chol)] <- mean_chol

mean_thalach <- mean(data$thalach, na.rm = TRUE)
data_num$thalach[is.na(data_num$thalach)] <- mean_thalach

mean_oldpeak <- mean(data$oldpeak, na.rm = TRUE)
data_num$oldpeak[is.na(data_num$oldpeak)] <- mean_oldpeak



```

## He creado dos loop para que me plotee por una parte las variables numericas en distintos boxplots con sus respectivos titulos, y por otro lado para que me plotee las variables categoricas en distintos barplots.

```{r}

plot(data_num$thalach, main = "Thalach", xlab = "Pacientes", ylab = "Thalach")
hist(data_num$thalach, col = "blue")
boxplot(data_num$year)


shapiro.test(data_num$age)
edad <- log(data_num$age)
shapiro.test(edad)
hist(edad)

par(mfrow = c(1,2))
hist(data_num$thalach)
boxplot(data_num$thalach, col = 4)

data_num$year <- NULL


par(mfrow = c(3, 2))

for(i in 1:ncol(data_num)) {
  boxplot(data_num[i],
          main = names(data_num[i]),col = "blue")
}

pdf("migrafico2.pdf")

par(mfrow=c(2,4))

for(i in 1:ncol(data_fac)){
  probabilidad <- prop.table(table(data_fac[i]))
  chisq <- chisq.test(table(data_fac[i]))
  nombres_variable <- names(data_fac)[i]
  co <- ifelse(chisq$p.value<exp(-15), "blue", "red")
  barplot(probabilidad, horiz = TRUE,
          main = paste0(nombres_variable, "- p.value", round(chisq$p.value,11)), col = co)
}

dev.off



```

## Generamos una funcion para despues meter las variable numericas para centrarlos y normalizarlos, para centrar quitamos la media, y para normalizar dividimos los datos normalizados por la desviacion estandar. Despues realizamos un loop para que lleve a cabo la funcion para las cinco variables numericas. 

```{r}


data_num_normal <- function(x=NULL){
  media=mean(x, na.rm=TRUE)
  centrado=x-media
  des_est <- sd(x,na.rm=TRUE)
  datos_cent_normalizado=centrado/des_est
  return(datos_cent_normalizado)
}

datos_centrados <- matrix(nrow=303,ncol=5)
for(i in 1:5){
  datos_centrados[,i] <- data_num_normal(data_num[,i])
}

datos_centrados <- as.data.frame(datos_centrados)
data_num_total <- cbind(data_num, datos_centrados)


```

##Calcular los p valores respecto de cada variable respecto al target.

```{r}
pvalores <- data.frame()
nombres_variable <- data.frame()
pvalores_fac <- data.frame()

for(i in 1:ncol(data_fac)){
  chisq <- chisq.test(table(data_fac[i]))
  pvalor <- (chisq$p.value)
  pvalores <- rbind(pvalores, pvalor)
  nombre <- names(data_fac[i])
  nombres_variable <- (rbind(nombres_variable, nombre))
  
}

pvalores_fac <- cbind(pvalores, nombres_variable)
pvalores_fac <- as.matrix(pvalores_fac)
pvalores_fac <- tail(sort(pvalores_fac))


```

## He creado dos data frames vacios para que en el loop vaya metiendo los p valores y el respectivo nombre de la variable para despues unirlos y tener una tabla de los p valores de las variables respecto al target.
```{r}

pvalores <- data.frame()
nombres_variable <- data.frame()
n <- 1

for(i in 6:10){
  mod <- as.formula(sprintf("target ~ %s", data_num_total[i]))
  glmodel <- glm(formula=mod, data = data_num_total, family=binomial(link="logit"))
  summary(glmodel)$coefficients[2,4]
  pvalor <- (summary(glmodel)$coefficients[2,4])
  pvalores <- rbind(pvalores, pvalor)
  nombre <- names(data_num_total[n])
  nombres_variable <- (rbind(nombres_variable, nombre))
  n <- n+1
}

pvalores_num <- cbind(pvalores, nombres_variable)
pvalores_num <- as.matrix(pvalores_num)
pvalores_num <- tail(sort(pvalores_num))

```





